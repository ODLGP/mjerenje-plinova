<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MOP Mjerenje">
<meta name="theme-color" content="#2e7d32">
<meta name="description" content="Aplikacija za mjerenje emisija plinova iz odlagali≈°ta otpada">
<title>‚ôªÔ∏è Mjerenje odlagali≈°nih plinova</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<style>
:root {
  --primary: #2e7d32;
  --primary-light: #4caf50;
  --secondary: #ff9800;
  --light-bg: #dddddd;
  --card-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
body {
  max-width: 900px;
  margin: 30px auto;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: #333;
  font-size: 16px;
  padding: 15px;
  background-color: var(--light-bg);
}
.screen {
  display: none;
  background: rgba(255,255,255,0.92);
  border-radius: 12px;
  padding: 25px;
  box-shadow: var(--card-shadow);
  margin-bottom: 25px;
  border: 2px solid var(--primary);
  position: relative;
  overflow: hidden;
}
.screen::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 5px;
  background: var(--primary);
}
.login-header, .topbar {
  text-align: center;
  margin-bottom: 25px;
}
.logo {
  display: block;
  margin: 0 auto 15px;
  max-width: 300px;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
}
h1, h2, h3 {
  color: var(--primary);
  margin-top: 0;
}
select, input, button, textarea {
  width: 100%;
  padding: 14px;
  margin-bottom: 18px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
  box-sizing: border-box;
  transition: all 0.3s;
}
select:focus, input:focus, textarea:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
  outline: none;
}
button {
  background-color: var(--primary);
  color: white;
  font-weight: bold;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s;
  padding: 14px;
  border-radius: 8px;
  font-size: 16px;
}
button:hover {
  background-color: var(--primary-light);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
button.secondary {
  background-color: var(--secondary);
}
button.secondary:hover {
  background-color: #f57c00;
}
.success-message {
  background-color: var(--primary);
  color: white;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  margin: 15px 0;
  display: none;
}
.warning-message {
  background-color: #fff3f3;
  color: #c00;
  padding: 12px;
  border-radius: 8px;
  margin: 15px 0;
  text-align: center;
  display: none;
  border: 1px solid #ffcdd2;
}
.button-group {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}
.button-group button {
  flex: 1;
}
.vent-table-container {
  overflow-x: auto;
  border-radius: 8px;
  box-shadow: var(--card-shadow);
  margin-top: 20px;
}
.vent-table {
  width: 100%;
  min-width: 700px;
  border-collapse: collapse;
  font-size: 14px;
}
.vent-table th, .vent-table td {
  border: 1px solid #e0e0e0;
  padding: 8px;
  text-align: center;
}
.vent-table th {
  background-color: var(--primary);
  color: white;
  white-space: nowrap;
}
.vent-table td {
  white-space: nowrap;
  cursor: pointer;
}
.vent-table td:last-child {
  white-space: normal;
  cursor: default;
}
.form-group {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 10px;
}
.form-group > div {
  display: flex;
  flex-direction: column;
}
.status-group {
  display: flex;
  gap: 15px;
  margin: 10px 0;
  align-items: center;
}
textarea {
  min-height: 80px;
  resize: vertical;
}
.history-item {
  background: white;
  border: 1px solid #eee;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: var(--card-shadow);
  transition: all 0.3s;
}
.history-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}
#landfill-map {
  display: block;
  width: 100%;
  max-height: 400px;
  object-fit: contain;
  margin: 20px 0;
  border-radius: 8px;
  border: 1px solid #ddd;
}
#vent-form {
  display: none;
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  margin: 20px 0;
  border: 2px solid var(--primary);
}
.topbar {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 15px;
}
.topbar button {
  width: auto;
  padding: 10px 20px;
  font-size: 15px;
  background: var(--secondary);
}
.login-container {
  max-width: 500px;
  margin: 0 auto;
}
.device-selector {
  margin: 20px 0;
  padding: 15px;
  background: #e8f5e9;
  border-radius: 10px;
  border-left: 4px solid var(--primary);
}
.device-dropdown-label {
  font-size: 15px;
  color: #222;
  font-weight: 500;
  margin-bottom: 7px;
  display: block;
}
.device-dropdown {
  position: relative;
  margin-bottom: 18px;
}
.device-dropdown-selected {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 12px 14px;
  background: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  min-height: 48px;
  transition: border-color 0.2s;
}
.device-dropdown-selected img {
  width: 38px;
  height: 32px;
  object-fit: contain;
  border-radius: 5px;
  margin-right: 12px;
  border: 1px solid #eee;
  background: #fafafa;
}
.device-dropdown-list {
  position: absolute;
  left: 0; right: 0; top: 110%;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.09);
  z-index: 100;
  display: none;
  max-height: 220px;
  overflow-y: auto;
  padding: 0;
  margin: 0;
}
.device-dropdown-list.open { display: block; }
.device-dropdown-option {
  display: flex;
  align-items: center;
  padding: 10px 14px;
  cursor: pointer;
  transition: background 0.15s;
  border-bottom: 1px solid #f2f2f2;
  background: #fff;
  font-size: 16px;
}
.device-dropdown-option:last-child { border-bottom: none; }
.device-dropdown-option:hover, .device-dropdown-option.selected {
  background: #e8f5e9;
}
.device-dropdown-option img {
  width: 38px;
  height: 32px;
  object-fit: contain;
  border-radius: 5px;
  margin-right: 12px;
  border: 1px solid #eee;
  background: #fafafa;
}
.device-dropdown-arrow {
  margin-left: auto;
  font-size: 18px;
  color: #888;
  pointer-events: none;
}
.login-footer {
  text-align: center;
  margin-top: 25px;
  font-size: 14px;
  color: #666;
}
#history-list .history-item .button-group {
  margin-top: 15px;
}
#add-vent-btn {
  margin: 15px 0;
  background: #2196F3;
}
#add-vent-btn:hover {
  background: #0b7dda;
}
.grid-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}
.landfill-card {
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 15px;
  text-align: center;
  background: white;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: var(--card-shadow);
  position: relative;
  overflow: hidden;
}
.landfill-card.selected {
  border: 2px solid var(--primary);
  background-color: #f0fff0;
}
.landfill-card img {
  width: 100%;
  height: 90px;
  object-fit: cover;
  border-radius: 6px;
  margin-bottom: 10px;
  border: 1px solid #eee;
}
.time-select-group {
  display: flex;
  gap: 8px;
  align-items: center;
}
.time-select-group select {
  width: auto;
  min-width: 70px;
  margin-bottom: 0;
}
#vent-select-modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0; top: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.33);
  align-items: center;
  justify-content: center;
}
#vent-select-modal .modal-content {
  background: #fff;
  border-radius: 10px;
  padding: 30px 25px 20px 25px;
  min-width: 250px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.18);
  text-align: center;
}
#vent-select-modal select {
  width: 100%;
  margin-bottom: 18px;
}
#vent-select-modal button {
  width: 100%;
}
#landfill-name-display {
  text-align: center;
  margin-top: 0;
  margin-bottom: 10px;
  font-size: 2rem;
  color: var(--primary);
}
#manual-vent-modal {
  display: none;
  position: fixed;
  z-index: 2100;
  left: 0; top: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.33);
  align-items: center;
  justify-content: center;
}
#manual-vent-modal .modal-content {
  background: #fff;
  border-radius: 10px;
  padding: 30px 25px 20px 25px;
  min-width: 250px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.18);
  text-align: center;
}
#manual-vent-modal input {
  width: 100%;
  margin-bottom: 18px;
}
#success-modal {
  display: none;
  position: fixed;
  z-index: 3000;
  left: 0; top: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  align-items: center;
  justify-content: center;
}
#success-modal .modal-content {
  background: #fff;
  border-radius: 15px;
  padding: 50px 40px;
  min-width: 400px;
  max-width: 500px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  text-align: center;
  animation: slideIn 0.3s ease-out;
}
@keyframes slideIn {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}
#success-modal .success-icon {
  font-size: 80px;
  color: var(--primary);
  margin-bottom: 20px;
}
#success-modal h2 {
  color: var(--primary);
  font-size: 28px;
  margin-bottom: 15px;
}
#success-modal p {
  color: #666;
  font-size: 16px;
  margin-bottom: 30px;
}
#success-modal button {
  width: 100%;
  padding: 15px;
  font-size: 18px;
  background: var(--primary);
  margin-bottom: 0;
}
.filter-bar {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  background: white;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  box-shadow: var(--card-shadow);
  align-items: end;
}
.filter-bar .filter-group {
  display: flex;
  flex-direction: column;
}
.filter-bar button {
  width: 100%;
  margin-bottom: 0;
}
.share-btn {
  background-color: #3498db;
}
.share-btn:hover {
  background-color: #2980b9;
}
@media (max-width: 600px) {
  body {
    padding: 10px;
    font-size: 15px;
  }
  .form-group {
    grid-template-columns: 1fr;
  }
  .time-select-group select {
    min-width: 60px;
  }
}
</style>
</head>
<body>
<div class="screen" id="password-screen">
  <div class="login-container">
    <div class="login-header">
      <h1>‚ôªÔ∏è Mjerenje odlagali≈°nih plinova</h1>
      <p style="color:#666;margin:10px 0;">Unesite pristupni kod:</p>
    </div>
    <form autocomplete="off" id="password-form">
      <label for="password-input">Pristupni kod:</label>
      <input type="password" id="password-input" placeholder="Unesite kod" required autofocus>
      <button type="submit">Prijavi se</button>
    </form>
    <div class="login-footer">
      <p>Sustav za praƒáenje emisija plinova iz odlagali≈°ta otpada</p>
    </div>
  </div>
</div>
<div class="screen" id="login-screen">
  <div class="login-container">
    <div class="login-header">
      <h1>‚ôªÔ∏è Mjerenje odlagali≈°nih plinova</h1>
      <p style="color:#666;margin:10px 0;">Odaberite mjeritelja i ureƒëaj za poƒçetak:</p>
    </div>
    <form autocomplete="off" id="login-form">
      <label for="measurer-select">Mjeritelj:</label>
      <select id="measurer-select" required>
        <option value="">Odaberite mjeritelja</option>
      </select>
      <div class="device-selector">
        <span class="device-dropdown-label">Kori≈°teni ureƒëaj za mjerenje:</span>
        <div id="device-dropdown" class="device-dropdown" tabindex="0"></div>
        <input type="hidden" id="device-select" name="device-select" required>
      </div>
      <button type="submit">Nastavi</button>
    </form>
    <div class="login-footer">
      <p>Sustav za praƒáenje emisija plinova iz odlagali≈°ta otpada</p>
      <button id="go-to-history" style="margin-top:20px;background:#e67e22;">üìú Povijest mjerenja</button>
    </div>
  </div>
</div>
<div class="screen" id="template-landfill-screen">
  <div class="topbar">
    <button onclick="safeResetToLogin()" type="button">Povratak na naslovnu</button>
  </div>
  <h2>Odaberite odlagali≈°te:</h2>
  <div class="grid-container" id="landfill-grid"></div>
  <div class="warning-message" id="template-landfill-warning"></div>
  <div class="button-group">
    <button id="template-landfill-next">Nastavi na mjerenje</button>
  </div>
</div>
<div class="screen" id="new-measurement">
  <div class="topbar">
    <button onclick="safeResetToLogin()" type="button">Povratak na naslovnu</button>
  </div>
  <h1>Novo mjerenje</h1>
  <form id="measurement-form">
    <div class="form-group">
      <div>
        <label>Datum:</label>
        <input id="measurement-date" required type="date">
      </div>
      <div>
        <label>Vrijeme poƒçetka:</label>
        <div class="time-select-group">
          <select id="start-hour" required>
            <option value="">Sat</option>
          </select>
          <span>:</span>
          <select id="start-minute" required>
            <option value="">Min</option>
          </select>
        </div>
      </div>
    </div>
    <div style="margin-bottom:15px;">
      <button type="button" id="refresh-weather-btn" style="background:#3498db;padding:10px;font-size:14px;">
        üå§Ô∏è Osvje≈æi vremenske podatke
      </button>
    </div>
    <div class="form-group">
      <div>
        <label>Temperatura zraka (¬∞C):</label>
        <input id="air-temp" required step="0.1" type="number">
      </div>
      <div>
        <label>Tlak zraka (hPa):</label>
        <input id="air-pressure" required step="0.1" type="number">
      </div>
    </div>
    <div class="form-group">
      <div>
        <label>Smjer vjetra:</label>
        <input id="wind-direction" required type="text">
      </div>
      <div>
        <label>Brzina vjetra (m/s):</label>
        <input id="wind-speed" required step="0.1" type="number">
      </div>
    </div>
    
    <div class="button-group">
      <button onclick="showScreen('template-landfill-screen')" type="button">Natrag</button>
      <button id="measurement-submit-btn" type="submit">Nastavi na unos odu≈°nika</button>
    </div>
  </form>
</div>
<div class="screen" id="vent-mapping">
  <div class="topbar">
    <button onclick="safeResetToLogin()" type="button">Povratak na naslovnu</button>
  </div>
  <h1 id="landfill-name-display"></h1>
  <img id="landfill-map" src="https://via.placeholder.com/800x500?text=Karta+odlagali≈°ta">
  <div style="display:flex;gap:10px;justify-content:center;margin-bottom:10px;">
    <button id="add-vent-btn" style="flex:1;">Unesi novi odu≈°nik</button>
  </div>
  <div class="success-message" id="success-message">
    Mjerenje uspje≈°no spremljeno! Podaci su pohranjeni.
  </div>
  <div class="warning-message" id="missing-vents-warning" style="display:none;"></div>
  <div class="vent-table-container">
    <table class="vent-table">
      <thead>
        <tr>
          <th>Odu≈°nik</th>
          <th>CH‚ÇÑ [%]</th>
          <th>CO‚ÇÇ [%]</th>
          <th>O‚ÇÇ [%]</th>
          <th>H‚ÇÇ (ppm)</th>
          <th>H‚ÇÇS (ppm)</th>
          <th>Temp (¬∞C)</th>
          <th>Status</th>
          <th>Napomena</th>
          <th style="min-width:180px;">Akcija</th>
        </tr>
      </thead>
      <tbody id="vent-list"></tbody>
    </table>
  </div>
  <div class="button-group">
    <button onclick="showScreen('new-measurement')">Natrag</button>
    <button class="secondary" id="finish-measurement">Zavr≈°i mjerenje</button>
  </div>
  <div id="vent-select-modal">
    <div class="modal-content">
      <h2>Odaberi odu≈°nik</h2>
      <select id="vent-select-dropdown">
        <option value="">Odaberi odu≈°nik</option>
      </select>
      <button id="vent-select-confirm">Dalje</button>
      <button onclick="closeVentSelectModal()" style="margin-top:8px;background:#bbb;">Odustani</button>
      <div style="margin-top:16px;">
        <button id="manual-vent-open" style="background:#607d8b;">Ruƒçno unesi novi odu≈°nik</button>
      </div>
    </div>
  </div>
  <div id="manual-vent-modal">
    <div class="modal-content">
      <h2>Dodaj ruƒçno novi odu≈°nik</h2>
      <input id="manual-vent-input" type="text" placeholder="Naziv odu≈°nika">
      <button id="manual-vent-confirm">Dodaj</button>
      <button onclick="closeManualVentModal()" style="margin-top:8px;background:#bbb;">Odustani</button>
    </div>
  </div>
  <div id="success-modal">
    <div class="modal-content">
      <div class="success-icon">‚úÖ</div>
      <h2>Mjerenje zavr≈°eno!</h2>
      <p>Excel datoteka je automatski preuzeta.<br>Podaci su uspje≈°no spremljeni u sustav.</p>
      <button onclick="closeSuccessModal()">Vrati se na naslovnu stranicu</button>
    </div>
  </div>
  <form id="vent-form">
    <h2>Podaci odu≈°nika</h2>
    <input id="vent-index" type="hidden" value="-1">
    <label>Naziv odu≈°nika:</label>
    <input id="vent-name" required type="text" readonly>
    
    <div class="form-group">
      <div>
        <label>CH‚ÇÑ [%]:</label>
        <input id="ch4" step="0.01" type="number" inputmode="decimal">
      </div>
      <div>
        <label>CO‚ÇÇ [%]:</label>
        <input id="co2" step="0.01" type="number" inputmode="decimal">
      </div>
      <div>
        <label>O‚ÇÇ [%]:</label>
        <input id="o2" step="0.01" type="number" inputmode="decimal">
      </div>
      <div>
        <label>H‚ÇÇ [ppm]:</label>
        <input id="h2" type="number" step="1" inputmode="numeric">
      </div>
      <div>
        <label>H‚ÇÇS [ppm]:</label>
        <input id="h2s" type="number" step="1" inputmode="numeric">
      </div>
      <div>
        <label>Temp. odu≈°nika (¬∞C):</label>
        <input id="vent-temp" step="0.1" type="number" inputmode="decimal">
      </div>
    </div>
    <label>Status:</label>
    <div class="status-group">
      <div>
        <input checked id="status-measured" name="vent-status" type="radio" value="measured">
        <label for="status-measured">Izmjeren</label>
      </div>
      <div>
        <input id="status-not-measurable" name="vent-status" type="radio" value="not_measurable">
        <label for="status-not-measurable">Ne mo≈æe se izmjeriti</label>
      </div>
    </div>
    <label>Napomena:</label>
    <textarea id="vent-note"></textarea>
    <div class="button-group">
      <button onclick="document.getElementById('vent-form').style.display='none'" type="button">Odustani</button>
      <button type="submit">Spremi odu≈°nik</button>
    </div>
  </form>
</div>
<div class="screen" id="measurement-history">
  <div class="topbar">
    <button onclick="resetToLogin()" type="button">Povratak na naslovnu</button>
  </div>
  <h1>Povijest mjerenja</h1>
  <div class="filter-bar">
    <div class="filter-group">
      <label for="filter-landfill-select">Odlagali≈°te:</label>
      <select id="filter-landfill-select">
        <option value="">Sva odlagali≈°ta</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="filter-measurer-select">Mjeritelj:</label>
      <select id="filter-measurer-select">
        <option value="">Svi mjeritelji</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="filter-start-date">Od datuma:</label>
      <input type="date" id="filter-start-date">
    </div>
    <div class="filter-group">
      <label for="filter-end-date">Do datuma:</label>
      <input type="date" id="filter-end-date">
    </div>
    <button id="apply-filters-btn">Filtriraj</button>
    <button id="clear-filters-btn" style="background:#6c757d;">Poni≈°ti filtere</button>
  </div>
  <div id="history-list"></div>
  <button onclick="resetToLogin()">Povratak na naslovnu</button>
</div>
<script>
  
// --- Custom device dropdown ---
const DEVICES = [
  {
    value: "Geotech GA5000",
    label: "Geotech GA5000",
    img: "slike/uredjaji/GA5000.jpg"
  },
  {
    value: "MRU Optima Biogas",
    label: "MRU Optima Biogas",
    img: "slike/uredjaji/Optima-Biogas.png"
  }
];
function renderDeviceDropdown() {
  const dropdown = document.getElementById('device-dropdown');
  dropdown.innerHTML = '';
  let selected = null;
  const hiddenInput = document.getElementById('device-select');
  const prevValue = hiddenInput.value;
  if (prevValue) selected = DEVICES.find(d => d.value === prevValue);
  let selectedDevice = selected || null;
  const selectedDiv = document.createElement('div');
  selectedDiv.className = 'device-dropdown-selected';
  selectedDiv.tabIndex = 0;
  selectedDiv.innerHTML = `
    ${selectedDevice ? `<img src="${selectedDevice.img}" alt="${selectedDevice.label}">` : ''}
    <span>${selectedDevice ? selectedDevice.label : 'Odaberite ureƒëaj'}</span>
    <span class="device-dropdown-arrow">&#9662;</span>
  `;
  dropdown.appendChild(selectedDiv);
  const list = document.createElement('div');
  list.className = 'device-dropdown-list';
  DEVICES.forEach(device => {
    const opt = document.createElement('div');
    opt.className = 'device-dropdown-option' + (selectedDevice && device.value === selectedDevice.value ? ' selected' : '');
    opt.innerHTML = `<img src="${device.img}" alt="${device.label}"><span>${device.label}</span>`;
    opt.addEventListener('click', function(e) {
      e.stopPropagation();
      selectedDiv.innerHTML = `<img src="${device.img}" alt="${device.label}"><span>${device.label}</span><span class="device-dropdown-arrow">&#9662;</span>`;
      hiddenInput.value = device.value;
      hiddenInput.dispatchEvent(new Event('change'));
      list.classList.remove('open');
      list.querySelectorAll('.device-dropdown-option').forEach(x=>x.classList.remove('selected'));
      opt.classList.add('selected');
    });
    list.appendChild(opt);
  });
  dropdown.appendChild(list);
  selectedDiv.addEventListener('click', function(e) {
    e.stopPropagation();
    list.classList.toggle('open');
  });
  selectedDiv.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      list.classList.toggle('open');
    }
  });
  document.addEventListener('click', function(e) {
    if (!dropdown.contains(e.target)) {
      list.classList.remove('open');
    }
  });
}
document.addEventListener('DOMContentLoaded', function() {
  renderDeviceDropdown();
});

// --- Ostatak aplikacije ---
const MEASURERS = [
  'Kristijan Li≈°ƒçinski',
  'Sven Jambru≈°iƒá',
  'Gordan Golja',
  'Luka Gu≈°tin',
  'Tomislav Haramba≈°iƒá'
];
const VENTS_BY_LANDFILL = {
  1: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21"],
  2: ["A1", "A2", "A4", "A6", "A7", "A8", "B3", "Z1", "Z2", "Z3", "Z4", "Z5", "Z6", "Z7", "Z8", "Z9", "Z10", "Z11", "Z12", "Z13", "Z14", "Z15", "Z16", "Z17", "Z18", "Z19"],
  3: ["1-3", "2-2", "2-3", "2-4", "3-2", "3-3", "3-4", "4-2", "4-3", "4-4", "5-2", "5-3", "5-4", "6-2", "6-3", "6-4", "10-1", "10-2", "10-3", "10-4", "10-5", "9-1", "9-2", "9-3", "9-4", "9-5", "8-1", "8-2", "8-3", "8-4", "8-5"],
  4: ["N1", "N2", "N3", "N4"],
  5: ["23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34"],
  6: ["Z01", "Z02", "Z03", "Z04", "Z05", "Z06", "Z07", "Z08", "Z09", "Z10", "Z11", "Z12", "Z13", "Z14", "Z15", "Z16", "Z17", "Z18", "Z19", "Z20", "Z21"],
  7: ["1", "6", "7", "8", "9", "10"],
  8: ["1", "2", "3", "4", "5", "6", "Z1", "Z2", "N01", "N02", "N03", "N04", "N05", "N06", "N07", "N08", "N09", "N10", "N11" ],
  9: [],
  10: [],
  11: ["1", "2", "3", "4", "5"],
  12: ["1", "2", "3", "4", "5", "6", "7"],
  13: ["1", "2", "3", "4", "5"],
  14: ["11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28"],
  15: ["1", "2", "3", "4", "5", "6", "7"],
  16: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "12", "13", "14"],
  17: ["1", "2"],
  18: ["B-5", "B-6", "B-11", "B-12", "B-13", "B-14", "B-15", "B-16", "B-17", "B-18", "B-19", "B-21", "B-25"], 
  19: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "12", "13", "14", "15", "16", "1N", "2N", "3N" ],
  20: ["Z01", "Z02", "Z03", "Z04", "Z05", "Z06"],
};
const LANDFILLS = [
  { id: 1, name: 'Odlagali≈°te otpada Kri≈æevci', image: 'slike/odlagalista/Krizevci.jpg', lat: 46.0219, lon: 16.5425, 
    client: 'ƒåistoƒáa Kri≈æevci d.o.o., Ulica Ivana Gorana Kovaƒçiƒáa 1, 48260 Kri≈æevci',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì ƒåistoƒáa Kri≈æevci d.o.o., Kri≈æevci' },
  { id: 2, name: 'Odlagali≈°te otpada Koprivnica', image: 'slike/odlagalista/Koprivnica.jpg', lat: 46.1636, lon: 16.8297,
    client: 'Komunalac Koprivnica d.o.o., Ulica Antuna Nemƒçiƒáa 5, 48000 Koprivnica',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì Komunalac Koprivnica d.o.o., Koprivnica' },
  { id: 3, name: 'Odlagali≈°te otpada Virovitica', image: 'slike/odlagalista/Virovitica.jpg', lat: 45.8319, lon: 17.3836,
    client: 'ƒåistoƒáa Virovitica d.o.o., Ulica Matije Gupca 78, 33000 Virovitica',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì ƒåistoƒáa Virovitica d.o.o., Virovitica' },
  { id: 4, name: 'Odlagali≈°te otpada Grubi≈°no Polje', image: 'slike/odlagalista/Grubisno-Polje.jpg', lat: 45.6989, lon: 17.1753,
    client: 'Komunalac d.o.o. Grubi≈°no Polje, Ivana Nepomuka Jemer≈°iƒáa 37c, 43290 Grubi≈°no Polje',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì Komunalac d.o.o. Grubi≈°no Polje, Prdavac - Grubi≈°no Polje' },
  { id: 5, name: 'Odlagali≈°te otpada Beli≈°ƒáe', image: 'slike/odlagalista/Belisce.jpg', lat: 45.6806, lon: 18.4042,
    client: 'Beli≈°ƒáe Komunalac d.o.o., Trg Josipa Runjanina 1, 31551 Beli≈°ƒáe',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì Beli≈°ƒáe Komunalac d.o.o., Beli≈°ƒáe' },
  { id: 6, name: 'Odlagali≈°te otpada Beli Manastir', image: 'slike/odlagalista/Beli-Manastir.jpg', lat: 45.7697, lon: 18.6042,
    client: 'Komunalac Beli Manastir d.o.o., Ulica Josipa Jelaƒçiƒáa 10, 31300 Beli Manastir',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì Komunalac Beli Manastir d.o.o., Beli Manastir' },
  { id: 7, name: 'Odlagali≈°te otpada Pag', image: 'slike/odlagalista/Pag.jpg', lat: 44.4450, lon: 15.0597,
    client: 'Vodovod Pag d.o.o., Ulica Jurja Dalmatinca 1, 23250 Pag',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì Vodovod Pag d.o.o., Pag' },
  { id: 8, name: 'Odlagali≈°te otpada Otoƒçac', image: 'slike/odlagalista/Otocac.jpg', lat: 44.8697, lon: 15.2378,
    client: 'Komunalac Otoƒçac d.o.o., Ulica Vladimira Nazora 4, 53220 Otoƒçac',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì Komunalac Otoƒçac d.o.o., Otoƒçac' },
  { id: 9, name: 'Odlagali≈°te otpada Zadar - Diklo', image: 'slike/odlagalista/Zadar.jpg', lat: 44.1194, lon: 15.2314,
    client: 'ƒåistoƒáa Zadar d.o.o., Ulica Bo≈æe Periƒçiƒáa 5, 23000 Zadar',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì ƒåistoƒáa Zadar d.o.o., Zadar - Diklo' },
  { id: 10, name: 'Odlagali≈°te otpada Split - Karepovac', image: 'slike/odlagalista/Karepovac.jpg', lat: 43.5081, lon: 16.4402,
    client: 'ƒåistoƒáa Split d.o.o., Ulica Domovinskog rata 49, 21000 Split',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì ƒåistoƒáa Split d.o.o., Split - Karepovac' },
  { id: 11, name: 'Odlagali≈°te otpada Knin - Mala Promina', image: 'slike/odlagalista/Knin.jpg', lat: 44.0406, lon: 16.1966,
    client: 'Vodovod Knin d.o.o., Ulica Ante Starƒçeviƒáa 2, 22300 Knin',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì Vodovod Knin d.o.o., Knin - Mala Promina' },
  { id: 12, name: 'Odlagali≈°te otpada Kljakovaƒça - Obrovac', image: 'slike/odlagalista/Obrovac.jpg', lat: 44.2036, lon: 15.6772,
    client: 'Komunalac Obrovac d.o.o., Ulica Stjepana Radiƒáa 1, 23450 Obrovac',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì Komunalac Obrovac d.o.o., Kljakovaƒça - Obrovac' },
  { id: 13, name: 'Odlagali≈°te otpada Cere - Labin', image: 'slike/odlagalista/Labin.jpg', lat: 45.0931, lon: 14.1197,
    client: 'Komunalac Labin d.o.o., Ulica Rudarska 1, 52220 Labin',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì Komunalac Labin d.o.o., Cere - Labin' },
  { id: 14, name: 'Odlagali≈°te otpada Novi Dvori - Zapre≈°iƒá', image: 'slike/odlagalista/Zapresic.jpg', lat: 45.8564, lon: 15.8072,
    client: 'ƒåistoƒáa Zapre≈°iƒá d.o.o., Ulica Matije Gupca 68, 10290 Zapre≈°iƒá',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì ƒåistoƒáa Zapre≈°iƒá d.o.o., Novi Dvori - Zapre≈°iƒá' },
  { id: 15, name: 'Odlagali≈°te otpada Gri≈æa - Buzet', image: 'slike/odlagalista/Griza.jpg', lat: 45.4094, lon: 13.9667,
    client: 'Komunalac Buzet d.o.o., Ulica Fontana 6, 52420 Buzet',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì Komunalac Buzet d.o.o., Gri≈æa - Buzet' },
  { id: 16, name: 'Odlagali≈°te otpada Pr≈æiƒá - Cres', image: 'slike/odlagalista/Cres.jpg', lat: 44.9611, lon: 14.4084,
    client: 'Vodovod Cres d.o.o., Ulica Creskih kapetana 1, 51557 Cres',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì Vodovod Cres d.o.o., Pr≈æiƒá - Cres' },
  { id: 17, name: 'Odlagali≈°te otpada Bedekovƒçina', image: 'slike/odlagalista/Bedekovcina.jpg', lat: 46.0403, lon: 15.9942,
    client: 'Komunalac Bedekovƒçina d.o.o., Ulica Trg Eugena Kvaternika 10, 49221 Bedekovƒçina',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì Komunalac Bedekovƒçina d.o.o., Bedekovƒçina' },
  { id: 18, name: 'Odlagali≈°te otpada Basilica - Rovinj', image: 'slike/odlagalista/Rovinj.jpg', lat: 45.0808, lon: 13.6386,
    client: 'Komunalac Rovinj d.o.o., Ulica Carrera 1, 52210 Rovinj',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì Komunalac Rovinj d.o.o., Basilica - Rovinj' },
  { id: 19, name: 'Odlagali≈°te otpada Jelenƒçiƒái V - Pazin', image: 'slike/odlagalista/Pazin.jpg', lat: 45.2397, lon: 13.9364,
    client: 'Komunalac Pazin d.o.o., Ulica Vladimira Nazora 6, 52000 Pazin',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì Komunalac Pazin d.o.o., Jelenƒçiƒái V - Pazin' },
  { id: 20, name: 'Odlagali≈°te otpada Biljane Donje', image: 'slike/odlagalista/Biljane-Donje.jpg', lat: 45.4833, lon: 16.9167,
    client: 'Komunalac Biljane Donje d.o.o., Ulica Biljane Donje 1, 43000 Bjelovar',
    reportTitle: 'ISPITNI IZVJE≈†TAJ O MJERENJU EMISIJA ODLAGALI≈†NIH PLINOVA NA ODLAGALI≈†TU KOMUNALNOG OTPADA ‚Äì Komunalac Biljane Donje d.o.o., Biljane Donje' }
];
const state = {
  selectedLandfill: null,
  currentMeasurer: "",
  currentDevice: "",
  currentMeasurement: {
    measurer: '',
    device: '',
    landfill: null,
    date: new Date().toISOString().split('T')[0],
    airTemp: '',
    airPressure: '',
    windDirection: '',
    windSpeed: '',
    
    startTime: '',
    vents: []
  },
  editingIndex: -1,
  editingVentIndex: -1
};
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
  document.getElementById(id).style.display = 'block';
}
function clearMeasurementForm() {
  document.getElementById('measurement-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('start-hour').value = '';
  document.getElementById('start-minute').value = '';
  document.getElementById('air-temp').value = '';
  document.getElementById('air-pressure').value = '';
  document.getElementById('wind-direction').value = '';
  document.getElementById('wind-speed').value = '';
}
function resetToLogin() {
  state.currentMeasurer = "";
  state.currentDevice = "";
  state.selectedLandfill = null;
  state.editingIndex = -1;
  state.editingVentIndex = -1;
  state.currentMeasurement = {
    measurer: '',
    device: '',
    landfill: null,
    date: new Date().toISOString().split('T')[0],
    airTemp: '',
    airPressure: '',
    windDirection: '',
    windSpeed: '',
    
    startTime: '',
    vents: []
  };
  localStorage.removeItem('tempMeasurement');
  clearMeasurementForm();
  showScreen('password-screen');
}

function safeResetToLogin() {
  if (state.currentMeasurement.landfill) {
    if (confirm("Jeste li sigurni da ≈æelite napustiti unos? Neƒáe biti spremljeno.")) {
      resetToLogin();
    }
  } else {
    resetToLogin();
  }
}

function initLandfillGrid() {
  const grid = document.getElementById('landfill-grid');
  grid.innerHTML = '';
  state.selectedLandfill = null;
  LANDFILLS.forEach(landfill => {
    const card = document.createElement('div');
    card.className = 'landfill-card';
    card.innerHTML = `
    <img src="${landfill.image}" alt="${landfill.name}">
      <h3>${landfill.name}</h3>
    `;
    card.addEventListener('click', () => {
      document.querySelectorAll('.landfill-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      state.selectedLandfill = landfill;
    });
    grid.appendChild(card);
  });
}
function showVentForm() {
  openVentSelectModal();
}
function openVentSelectModal() {
  const modal = document.getElementById('vent-select-modal');
  const dropdown = document.getElementById('vent-select-dropdown');
  dropdown.innerHTML = '<option value="">Odaberi odu≈°nik</option>';
  let ventNames = [];
  if (state.selectedLandfill && VENTS_BY_LANDFILL[state.selectedLandfill.id]) {
    ventNames = VENTS_BY_LANDFILL[state.selectedLandfill.id];
  }
  const usedVents = state.currentMeasurement.vents.map(v => v.name);
  ventNames.filter(name => !usedVents.includes(name)).forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    dropdown.appendChild(opt);
  });
  modal.style.display = 'flex';
}
function closeVentSelectModal() {
  document.getElementById('vent-select-modal').style.display = 'none';
}
function openManualVentModal() {
  document.getElementById('manual-vent-input').value = '';
  document.getElementById('manual-vent-modal').style.display = 'flex';
}
function closeManualVentModal() {
  document.getElementById('manual-vent-modal').style.display = 'none';
}
function openSuccessModal() {
  document.getElementById('success-modal').style.display = 'flex';
}
function closeSuccessModal() {
  document.getElementById('success-modal').style.display = 'none';
  resetToLogin();
}

// Funkcija za dohvaƒáanje vremenskih podataka s Open-Meteo API
async function fetchWeatherData(lat, lon) {
  try {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,surface_pressure,wind_speed_10m,wind_direction_10m&timezone=Europe/Zagreb&wind_speed_unit=ms`;
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error('Gre≈°ka pri dohvaƒáanju vremenskih podataka');
    }
    
    const data = await response.json();
    return {
      temperature: data.current.temperature_2m.toFixed(1),
      pressure: data.current.surface_pressure.toFixed(1),
      windSpeed: data.current.wind_speed_10m.toFixed(1),
      windDirection: getWindDirection(data.current.wind_direction_10m)
    };
  } catch (error) {
    console.error('Gre≈°ka:', error);
    return null;
  }
}

// Funkcija za pretvaranje stupnjeva u smjer vjetra
function getWindDirection(degrees) {
  const directions = ['S', 'SSI', 'SI', 'ISI', 'I', 'IJI', 'JI', 'JJI', 'J', 'JJZ', 'JZ', 'ZJZ', 'Z', 'ZSZ', 'SZ', 'SSZ'];
  const index = Math.round(degrees / 22.5) % 16;
  return directions[index];
}

// Funkcija za postavljanje trenutnog vremena
function setCurrentTime() {
  const now = new Date();
  const hour = now.getHours().toString().padStart(2, '0');
  const minute = Math.floor(now.getMinutes() / 5) * 5; // Zaokru≈æi na najbli≈æih 5 minuta
  const minuteStr = minute.toString().padStart(2, '0');
  
  document.getElementById('start-hour').value = hour;
  document.getElementById('start-minute').value = minuteStr;
}

// Funkcija za automatsko popunjavanje vremenskih podataka
async function autoFillWeatherData() {
  if (!state.selectedLandfill) return;
  
  // Postavi trenutno vrijeme
  setCurrentTime();
  
  // Prika≈æi loading poruku
  const airTempInput = document.getElementById('air-temp');
  const airPressureInput = document.getElementById('air-pressure');
  const windDirectionInput = document.getElementById('wind-direction');
  const windSpeedInput = document.getElementById('wind-speed');
  
  airTempInput.placeholder = 'Uƒçitavanje...';
  airPressureInput.placeholder = 'Uƒçitavanje...';
  windDirectionInput.placeholder = 'Uƒçitavanje...';
  windSpeedInput.placeholder = 'Uƒçitavanje...';
  
  // Dohvati vremenske podatke
  const weatherData = await fetchWeatherData(state.selectedLandfill.lat, state.selectedLandfill.lon);
  
  if (weatherData) {
    airTempInput.value = weatherData.temperature;
    airPressureInput.value = weatherData.pressure;
    windDirectionInput.value = weatherData.windDirection;
    windSpeedInput.value = weatherData.windSpeed;
    
    // Resetiraj placeholdere
    airTempInput.placeholder = '';
    airPressureInput.placeholder = '';
    windDirectionInput.placeholder = '';
    windSpeedInput.placeholder = '';
  } else {
    alert('Nije moguƒáe dohvatiti vremenske podatke. Molimo unesite ruƒçno.');
    airTempInput.placeholder = '';
    airPressureInput.placeholder = '';
    windDirectionInput.placeholder = '';
    windSpeedInput.placeholder = '';
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // Dodaj validaciju za decimalna mjesta na input poljima (samo za MRU Optima Biogas)
  document.getElementById('ch4').addEventListener('input', function(e) {
    if (state.currentDevice !== 'MRU Optima Biogas') return; // Samo za MRU
    let val = e.target.value;
    if (val.includes('.')) {
      let parts = val.split('.');
      if (parts[1] && parts[1].length > 2) {
        e.target.value = parseFloat(val).toFixed(2);
      }
    }
  });
  
  document.getElementById('co2').addEventListener('input', function(e) {
    if (state.currentDevice !== 'MRU Optima Biogas') return; // Samo za MRU
    let val = e.target.value;
    if (val.includes('.')) {
      let parts = val.split('.');
      if (parts[1] && parts[1].length > 2) {
        e.target.value = parseFloat(val).toFixed(2);
      }
    }
  });
  
  document.getElementById('o2').addEventListener('input', function(e) {
    if (state.currentDevice !== 'MRU Optima Biogas') return; // Samo za MRU
    let val = e.target.value;
    if (val.includes('.')) {
      let parts = val.split('.');
      if (parts[1] && parts[1].length > 2) {
        e.target.value = parseFloat(val).toFixed(2);
      }
    }
  });
  
  document.getElementById('h2').addEventListener('input', function(e) {
    if (state.currentDevice !== 'MRU Optima Biogas') return; // Samo za MRU
    // Ukloni sve decimale
    e.target.value = e.target.value.replace(/\./g, '').replace(/[^\d]/g, '');
  });
  
  document.getElementById('h2s').addEventListener('input', function(e) {
    if (state.currentDevice !== 'MRU Optima Biogas') return; // Samo za MRU
    // Ukloni sve decimale
    e.target.value = e.target.value.replace(/\./g, '').replace(/[^\d]/g, '');
  });
  
  document.getElementById('vent-temp').addEventListener('input', function(e) {
    if (state.currentDevice !== 'MRU Optima Biogas') return; // Samo za MRU
    let val = e.target.value;
    if (val.includes('.')) {
      let parts = val.split('.');
      if (parts[1] && parts[1].length > 1) {
        e.target.value = parseFloat(val).toFixed(1);
      }
    }
  });
  
  document.getElementById('vent-select-confirm').onclick = function() {
    const dropdown = document.getElementById('vent-select-dropdown');
    const selected = dropdown.value;
    if (!selected) {
      alert("Odaberite odu≈°nik!");
      return;
    }
    document.getElementById('vent-name').value = selected;
    document.getElementById('vent-index').value = -1;
    document.getElementById('vent-form').reset();
    document.getElementById('vent-name').value = selected;
    document.getElementById('vent-form').style.display = 'block';
    closeVentSelectModal();
  };
  document.getElementById('manual-vent-open').onclick = function(e) {
    e.preventDefault();
    closeVentSelectModal();
    openManualVentModal();
  };
  document.getElementById('manual-vent-confirm').onclick = function() {
    const name = document.getElementById('manual-vent-input').value.trim();
    if (!name) {
      alert("Unesi naziv novog odu≈°nika!");
      return;
    }
    document.getElementById('vent-name').value = name;
    document.getElementById('vent-index').value = -1;
    document.getElementById('vent-form').reset();
    document.getElementById('vent-name').value = name;
    document.getElementById('vent-form').style.display = 'block';
    closeManualVentModal();
  };
});
function editVent(index) {
  const vent = state.currentMeasurement.vents[index];
  if (!vent) return;
  state.editingVentIndex = index;
  document.getElementById('vent-name').value = vent.name;
  document.getElementById('ch4').value = vent.ch4 || '';
  document.getElementById('co2').value = vent.co2 || '';
  document.getElementById('o2').value = vent.o2 || '';
  document.getElementById('h2').value = vent.h2 || '';
  document.getElementById('h2s').value = vent.h2s || '';
  document.getElementById('vent-temp').value = vent.temp || '';
  document.querySelector(`input[name="vent-status"][value="${vent.status}"]`).checked = true;
  document.getElementById('vent-note').value = vent.note || '';
  document.getElementById('vent-form').style.display = 'block';
  
  // Omoguƒái/onemoguƒái polja ovisno o statusu
  toggleVentFields();
}

function deleteVent(index) {
  if (!confirm("Jeste li sigurni da ≈æelite obrisati ovaj odu≈°nik?")) return;
  state.currentMeasurement.vents.splice(index, 1);
  localStorage.setItem('tempMeasurement', JSON.stringify(state.currentMeasurement));
  updateVentTable();
  updateMissingVentsWarning();
}

function toggleVentFields() {
  const status = document.querySelector('input[name="vent-status"]:checked').value;
  const fields = ['ch4', 'co2', 'o2', 'h2', 'h2s', 'vent-temp'];
  
  // Sva polja su uvijek omoguƒáena, ali validacija ovisi o statusu
  fields.forEach(id => {
    document.getElementById(id).required = false;
    document.getElementById(id).disabled = false;
  });
}
function saveVentData() {
  const name = document.getElementById('vent-name').value.trim();
  if (!name) {
    alert("Naziv odu≈°nika je obavezan!");
    return;
  }
  
  const status = document.querySelector('input[name="vent-status"]:checked').value;
  const ch4 = document.getElementById('ch4').value.trim();
  const co2 = document.getElementById('co2').value.trim();
  const o2 = document.getElementById('o2').value.trim();
  const h2 = document.getElementById('h2').value.trim();
  const h2s = document.getElementById('h2s').value.trim();
  const temp = document.getElementById('vent-temp').value.trim();
  
  // Ako je status "Izmjeren", sva polja moraju biti popunjena
  if (status === 'measured') {
    if (!ch4) {
      alert("Morate unijeti CH‚ÇÑ!");
      return;
    }
    if (!co2) {
      alert("Morate unijeti CO‚ÇÇ!");
      return;
    }
    if (!o2) {
      alert("Morate unijeti O‚ÇÇ!");
      return;
    }
    if (!h2) {
      alert("Morate unijeti H‚ÇÇ!");
      return;
    }
    if (!h2s) {
      alert("Morate unijeti H‚ÇÇS!");
      return;
    }
    if (!temp) {
      alert("Morate unijeti temperaturu odu≈°nika!");
      return;
    }
  }
  
  // Validacija decimala samo ako su polja popunjena
  if (ch4) {
    if (!/^\d+\.\d{2}$/.test(ch4)) {
      alert("CH‚ÇÑ mora imati toƒçno 2 decimale (npr. 45.50)!");
      return;
    }
  }
  if (co2) {
    if (!/^\d+\.\d{2}$/.test(co2)) {
      alert("CO‚ÇÇ mora imati toƒçno 2 decimale (npr. 30.25)!");
      return;
    }
  }
  if (o2) {
    if (!/^\d+\.\d{2}$/.test(o2)) {
      alert("O‚ÇÇ mora imati toƒçno 2 decimale (npr. 20.50)!");
      return;
    }
  }
  
  // Validacija za H2 i H2S (bez decimala)
  if (h2 && !/^\d+$/.test(h2)) {
    alert("H‚ÇÇ mora biti cijeli broj bez decimala!");
    return;
  }
  if (h2s && !/^\d+$/.test(h2s)) {
    alert("H‚ÇÇS mora biti cijeli broj bez decimala!");
    return;
  }
  
  // Validacija za temperaturu (1 decimala)
  if (temp) {
    if (!/^\d+\.\d{1}$/.test(temp)) {
      alert("Temperatura mora imati toƒçno 1 decimalu (npr. 25.5)!");
      return;
    }
  }
  
  const ventData = {
    name: name,
    ch4: ch4,
    co2: co2,
    o2: o2,
    h2: h2,
    h2s: h2s,
    temp: temp,
    status: status,
    note: document.getElementById('vent-note').value
  };
  if (state.editingVentIndex >= 0) {
    state.currentMeasurement.vents[state.editingVentIndex] = ventData;
  } else {
    state.currentMeasurement.vents.push(ventData);
  }
  
  // Spremi u privremenu pohranu
  localStorage.setItem('tempMeasurement', JSON.stringify(state.currentMeasurement));
  
  updateVentTable();
  updateMissingVentsWarning();
  document.getElementById('vent-form').style.display = 'none';
  document.getElementById('vent-form').reset();
  state.editingVentIndex = -1;
}
function updateVentTable() {
  const tbody = document.getElementById('vent-list');
  tbody.innerHTML = '';
  state.currentMeasurement.vents.forEach((vent, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${vent.name}</td>
      <td>${vent.ch4 || ''}</td>
      <td>${vent.co2 || ''}</td>
      <td>${vent.o2 || ''}</td>
      <td>${vent.h2 || ''}</td>
      <td>${vent.h2s || ''}</td>
      <td>${vent.temp || ''}</td>
      <td style="font-size:12px;">${vent.status === 'measured' ? 'Izmjeren' : 'Ne mo≈æe se izmjeriti'}</td>
      <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${vent.note || ''}</td>
      <td style="padding:4px;">
        <button style="padding:4px 8px;font-size:12px;width:100%;margin-bottom:4px;" onclick="editVent(${idx})">Uredi</button>
        <button style="padding:4px 8px;font-size:12px;width:100%;background:#e74c3c;" onclick="deleteVent(${idx})">Obri≈°i</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}
function updateMissingVentsWarning() {
  const warningDiv = document.getElementById('missing-vents-warning');
  if (!state.selectedLandfill || !VENTS_BY_LANDFILL[state.selectedLandfill.id]) {
    warningDiv.style.display = 'none';
    return;
  }
  const allVents = VENTS_BY_LANDFILL[state.selectedLandfill.id];
  const measuredVents = state.currentMeasurement.vents.map(v => v.name);
  const missing = allVents.filter(v => !measuredVents.includes(v));
  if (missing.length === 0) {
    warningDiv.style.display = 'none';
  } else {
    warningDiv.textContent = `Niste unijeli sljedeƒáe odusnike: ${missing.join(', ')}`;
    warningDiv.style.display = 'block';
  }
}
function finishMeasurement() {
  if (state.currentMeasurement.vents.length === 0) {
    alert("Morate unijeti barem jedan odu≈°nik!");
    return;
  }
  
  // Provjera da li su svi odu≈°nici uneseni
  if (state.selectedLandfill && VENTS_BY_LANDFILL[state.selectedLandfill.id]) {
    const allVents = VENTS_BY_LANDFILL[state.selectedLandfill.id];
    const measuredVents = state.currentMeasurement.vents.map(v => v.name);
    const missing = allVents.filter(v => !measuredVents.includes(v));
    
    if (missing.length > 0) {
      const confirmMsg = `Niste unijeli sljedeƒáe odu≈°nike: ${missing.join(', ')}\n\n≈Ωelite li ipak zavr≈°iti mjerenje?`;
      if (!confirm(confirmMsg)) {
        return;
      }
    }
  }
  
  // Dodaj vrijeme zavr≈°etka
  const now = new Date();
  const hour = now.getHours().toString().padStart(2, '0');
  const minute = now.getMinutes().toString().padStart(2, '0');
  state.currentMeasurement.endTime = `${hour}:${minute}`;
  
  const measurements = loadMeasurements();
  if (state.editingIndex >= 0) {
    measurements[state.editingIndex] = state.currentMeasurement;
  } else {
    measurements.push(state.currentMeasurement);
  }
  saveMeasurements(measurements);
  
  // Ukloni privremeno spremljeno mjerenje nakon ≈°to je zavr≈°eno
  localStorage.removeItem('tempMeasurement');
  
  // Spremi index za export
  const measurementIndex = state.editingIndex >= 0 ? state.editingIndex : measurements.length - 1;
  
  // Automatski exportaj u Excel
  exportToExcel(measurementIndex);
  
  // Prika≈æi success modal
  openSuccessModal();
}
function loadMeasurements() {
  return JSON.parse(localStorage.getItem('measurements') || '[]');
}
function saveMeasurements(arr) {
  localStorage.setItem('measurements', JSON.stringify(arr));
}
function updateHistoryList(filtered = null) {
  const measurements = filtered || loadMeasurements();
  const historyList = document.getElementById('history-list');
  historyList.innerHTML = '';
  if (measurements.length === 0) {
    historyList.innerHTML = '<p style="text-align:center;color:#888;">Nema zapisanih mjerenja.</p>';
    return;
  }
  measurements.slice().reverse().forEach((m, revIdx) => {
    const originalIndex = measurements.length - 1 - revIdx;
    const item = document.createElement('div');
    item.className = 'history-item';
    const ventCount = m.vents ? m.vents.length : 0;
    
    // Formatiranje vremena (ako postoje u objektu)
    const vrijemePocetka = m.startTime || 'Nije upisano';
    const vrijemeZavrsetka = m.endTime || 'Nije upisano';
    
    item.innerHTML = `
      <h3>${m.landfill.name}</h3>
      <p><strong>Datum:</strong> ${m.date}</p>
      <p><strong>Vrijeme:</strong> ${vrijemePocetka} - ${vrijemeZavrsetka}</p>
      <p><strong>Mjeritelj:</strong> ${m.measurer}</p>
      <p><strong>Ureƒëaj:</strong> ${m.device}</p>
      <p><strong>Broj odu≈°nika:</strong> ${ventCount}</p>
      <div class="button-group">
        <button class="share-btn" onclick="shareMeasurement(${originalIndex})">üì§ Podijeli</button>
        <button onclick="editMeasurement(${originalIndex})">Uredi</button>
        <button style="background:#e74c3c;" onclick="deleteMeasurement(${originalIndex})">Obri≈°i</button>
        <button style="background:#2c3e50;" onclick="exportToExcel(${originalIndex})">üíæ Excel</button>
      </div>
    `;
    historyList.appendChild(item);
  });
}
function editMeasurement(index) {
  const measurements = loadMeasurements();
  const m = measurements[index];
  state.currentMeasurement = m;
  state.currentMeasurer = m.measurer;
  state.currentDevice = m.device;
  state.selectedLandfill = m.landfill;
  state.editingIndex = index;
  showScreen('new-measurement');
  document.getElementById('measurer-select').value = m.measurer;
  document.getElementById('device-select').value = m.device;
  renderDeviceDropdown();
  document.getElementById('measurement-date').value = m.date;
  document.getElementById('air-temp').value = m.airTemp;
  document.getElementById('air-pressure').value = m.airPressure;
  document.getElementById('wind-direction').value = m.windDirection;
  document.getElementById('wind-speed').value = m.windSpeed;
  if (m.startTime) {
    const [hour, minute] = m.startTime.split(':');
    document.getElementById('start-hour').value = hour;
    document.getElementById('start-minute').value = minute;
  }
}
function deleteMeasurement(index) {
  if (!confirm("Jeste li sigurni da ≈æelite obrisati ovo mjerenje?")) return;
  const measurements = loadMeasurements();
  measurements.splice(index, 1);
  saveMeasurements(measurements);
  updateHistoryList();
}
function exportToExcel(index) {
  const measurements = loadMeasurements();
  const measurement = measurements[index];
  
  // Formatiranje vremena (ako postoje u objektu)
  const vrijemePocetka = measurement.startTime || 'Nije upisano';
  const vrijemeZavrsetka = measurement.endTime || 'Nije upisano';

 const aoa = [
    ["IZVJE≈†TAJ O MJERENJU ODLAGALI≈†NIH PLINOVA", "", "", "", "", "", "", "", "", ""],
    ["Obrazac ZM-05-G", "", "", "", "", "", "", "", ""],
    ["", "", "", "", "", "", "", "", "", ""],
    ["Lokacija i naziv odlagali≈°ta:", measurement.landfill.name, "", "", "", "Datum:", measurement.date, "", ""],
    ["", "", "", "", "", "", "", "", "", ""],
    ["Mjeritelj:", measurement.measurer, "", "", "", "Kori≈°teni ureƒëaj:", measurement.device, "", ""],
    ["", "", "", "", "", "", "", "", "", ""],
    ["Temperatura zraka [¬∞C]:", measurement.airTemp || "", "", "Smjer vjetra:", measurement.windDirection || "", ""],
    ["Tlak zraka [hPa]:", measurement.airPressure || "", "", "Brzina vjetra [m/s]:", measurement.windSpeed || "", "", "Poƒçetak mjerenja:", measurement.startTime || ""],
    ["", "", "", "", "", "", "", "", "", ""],
    ["Odu≈°ak", "CH4 [%]", "CO2 [%]", "O2 [%]", "H2 [ppm]", "H2S [ppm]", "Temperatura", "Status", "Napomena"]
  ];

  measurement.vents.forEach(vent => {
    aoa.push([
      vent.name,
      vent.ch4 || "",
      vent.co2 || "",
      vent.o2 || "",
      vent.h2 || "",
      vent.h2s || "",
      vent.temp || "",
      vent.status === 'measured' ? 'Izmjeren' : 'Ne mo≈æe se izmjeriti',
      vent.note || ""
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Mjerenje");

  const safeName = measurement.landfill.name.replace(/[^a-zA-Z0-9]/g, '_');
  const filename = `Mjerenje_${measurement.date.replace(/-/g, '_')}_${safeName}.xlsx`;

  XLSX.writeFile(wb, filename);
}

function exportToPDF(index) {
  // Stara PDF funkcija - zamijenjena s Word exportom
  exportToWord(index);
}

async function exportToWord(index) {
  const measurements = loadMeasurements();
  const measurement = measurements[index];
  
  // Provjeri da li je webhook URL postavljen
  if (!POWER_AUTOMATE_WEBHOOK_URL || POWER_AUTOMATE_WEBHOOK_URL === 'TVOJ_WEBHOOK_URL_OVDJE') {
    alert('Power Automate webhook URL nije postavljen!\n\nMolimo proƒçitaj UPUTE_POWER_AUTOMATE.md za upute kako postaviti integraciju.');
    return;
  }
  
  // Dohvati mjesec iz datuma
  const date = new Date(measurement.date);
  const months = ['SIJEƒåANJ', 'VELJAƒåA', 'O≈ΩUJAK', 'TRAVANJ', 'SVIBANJ', 'LIPANJ', 
                  'SRPANJ', 'KOLOVOZ', 'RUJAN', 'LISTOPAD', 'STUDENI', 'PROSINAC'];
  const month = months[date.getMonth()];
  const year = date.getFullYear();
  
  // Formatiraj datum za "u Zagrebu"
  const day = date.getDate().toString().padStart(2, '0');
  const monthNum = (date.getMonth() + 1).toString().padStart(2, '0');
  const dateFormatted = `${day}.${monthNum}.${year}`;
  
  // Pripremi podatke za Power Automate
  const data = {
    datum: dateFormatted,
    narucitelj: measurement.landfill.client || '',
    nazivDokumenta: `${measurement.landfill.reportTitle} (${month} ${year})`,
    mjesec: month,
    godina: year.toString()
  };
  
  try {
    // Prika≈æi poruku da se dokument generira
    const loadingMsg = document.createElement('div');
    loadingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:9999;text-align:center;';
    loadingMsg.innerHTML = '<h2 style="color:#2e7d32;margin:0 0 15px 0;">‚è≥ Generiranje dokumenta...</h2><p style="margin:0;color:#666;">Molimo priƒçekajte...</p>';
    document.body.appendChild(loadingMsg);
    
    // Po≈°alji zahtjev na Power Automate
    const response = await fetch(POWER_AUTOMATE_WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });
    
    // Ukloni poruku o uƒçitavanju
    document.body.removeChild(loadingMsg);
    
    if (!response.ok) {
      throw new Error(`HTTP gre≈°ka! Status: ${response.status}`);
    }
    
    // Preuzmi dokument kao blob
    const blob = await response.blob();
    
    // Stvori link za preuzimanje
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    const safeName = measurement.landfill.name.replace(/[^a-zA-Z0-9]/g, '_');
    link.download = `Naslovna_${measurement.date.replace(/-/g, '_')}_${safeName}.docx`;
    link.click();
    
    // Oƒçisti URL
    URL.revokeObjectURL(url);
    
    // Prika≈æi poruku o uspjehu
    alert('‚úÖ Dokument je uspje≈°no preuzet!');
    
  } catch (error) {
    console.error('Gre≈°ka pri generiranju dokumenta:', error);
    alert(`‚ùå Gre≈°ka pri generiranju dokumenta!\n\nDetalji: ${error.message}\n\nProvjeri:\n1. Da li je Power Automate tijek pokrenut\n2. Da li je webhook URL toƒçan\n3. Konzolu preglednika (F12) za vi≈°e detalja`);
  }
}

async function shareMeasurement(index) {
  if (navigator.share) {
    const measurements = loadMeasurements();
    const m = measurements[index];
    const ventCount = m.vents ? m.vents.length : 0;
    
    // Formatiranje vremena (ako postoje u objektu)
    const vrijemePocetka = m.startTime;
    const vrijemeZavrsetka = m.endTime;

    let ventSummary = "";
    if (ventCount > 0) {
      ventSummary = `\n\nüìä DETALJI PO ODU≈†NICIMA:\n${m.vents.map(v => 
        `üìç ${v.name}:\n` +
        `   CH‚ÇÑ: ${v.ch4 || '-'}%\n` +
        `   CO‚ÇÇ: ${v.co2 || '-'}%\n` +
        `   O‚ÇÇ: ${v.o2 || '-'}%\n` +
        `   H‚ÇÇ: ${v.h2 || '-'} ppm\n` +
        `   H‚ÇÇS: ${v.h2s || '-'} ppm\n` +
        `   Temp: ${v.temp || '-'}¬∞C\n` +
        `   Status: ${v.status === 'measured' ? 'Izmjeren' : 'Ne mo≈æe se izmjeriti'}\n` +
        `   Napomena: ${v.note || '-'}`
      ).join('\n\n')}`;
    }

    const shareData = {
      title: `Izvje≈°taj: ${m.landfill.name}`,
      text: `‚ôªÔ∏è IZVJE≈†TAJ MJERENJA PLINOVA\n` +
            `---------------------------\n` +
            `üìç Odlagali≈°te: ${m.landfill.name}\n` +
            `üìÖ Datum: ${m.date}\n` +
            `‚è∞ Vrijeme: ${vrijemePocetka} - ${vrijemeZavrsetka}\n` +
            `üë§ Mjeritelj: ${m.measurer}\n` +
            `üìü Ureƒëaj: ${m.device}\n` +
            `üí® Broj odu≈°nika: ${ventCount}` +
            `${ventSummary}`
    };

    try {
      await navigator.share(shareData);
    } catch(err) {
      console.error('Gre≈°ka pri dijeljenju:', err);
    }
  } else {
    alert('Dijeljenje nije podr≈æano na ovom pregledniku. Poku≈°ajte na mobilnom ureƒëaju.');
  }
}
function populateTimeDropdowns() {
  const hourSelect = document.getElementById('start-hour');
  const minuteSelect = document.getElementById('start-minute');
  hourSelect.innerHTML = '<option value="">Sat</option>';
  minuteSelect.innerHTML = '<option value="">Min</option>';
  for (let h = 0; h < 24; h++) {
    const val = h.toString().padStart(2, '0');
    hourSelect.innerHTML += `<option value="${val}">${val}</option>`;
  }
  for (let m = 0; m < 60; m += 5) {
    const val = m.toString().padStart(2, '0');
    minuteSelect.innerHTML += `<option value="${val}">${val}</option>`;
  }
}
function populateFilterDropdowns() {
  const landfillSelect = document.getElementById('filter-landfill-select');
  const measurerSelect = document.getElementById('filter-measurer-select');
  LANDFILLS.forEach(l => {
    const option = document.createElement('option');
    option.value = l.name;
    option.textContent = l.name;
    landfillSelect.appendChild(option);
  });
  MEASURERS.forEach(m => {
    const option = document.createElement('option');
    option.value = m;
    option.textContent = m;
    measurerSelect.appendChild(option);
  });
}
function applyFilters() {
  const landfillFilter = document.getElementById('filter-landfill-select').value;
  const measurerFilter = document.getElementById('filter-measurer-select').value;
  const startDateFilter = document.getElementById('filter-start-date').value;
  const endDateFilter = document.getElementById('filter-end-date').value;
  let measurements = loadMeasurements();
  const filtered = measurements.filter(m => {
    const matchLandfill = !landfillFilter || (m.landfill && m.landfill.name === landfillFilter);
    const matchMeasurer = !measurerFilter || m.measurer === measurerFilter;
    const matchDate = (!startDateFilter || m.date >= startDateFilter) && (!endDateFilter || m.date <= endDateFilter);
    return matchLandfill && matchMeasurer && matchDate;
  });
  updateHistoryList(filtered);
}
function clearFilters() {
  document.getElementById('filter-landfill-select').value = '';
  document.getElementById('filter-measurer-select').value = '';
  document.getElementById('filter-start-date').value = '';
  document.getElementById('filter-end-date').value = '';
  updateHistoryList();
}

function initApp() {
  // Ovdje zalijepi kod za Service Worker
  // Service Worker privremeno iskljuƒçen za GitHub Pages
  /*
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js');
    });
  }
  */

  // Ostatak tvog koda se nastavlja dalje...
  const select = document.getElementById('landfill-select');
  const filterSelect = document.getElementById('filter-landfill');
  // ...
  const measurerSelect = document.getElementById('measurer-select');
  MEASURERS.forEach(m => {
    const option = document.createElement('option');
    option.value = m;
    option.textContent = m;
    measurerSelect.appendChild(option);
  });
  populateTimeDropdowns();
  
  // Dodano: Uƒçitaj privremeno mjerenje ako postoji
  const savedMeasurement = localStorage.getItem('tempMeasurement');
  if (savedMeasurement) {
    if (confirm("Pronaƒëeno je nespremljeno mjerenje. ≈Ωelite li ga nastaviti?")) {
      const tempMeasurement = JSON.parse(savedMeasurement);
      state.currentMeasurement = tempMeasurement;
      state.currentMeasurer = tempMeasurement.measurer;
      state.currentDevice = tempMeasurement.device;
      state.selectedLandfill = tempMeasurement.landfill;
      showScreen('new-measurement');
      // A≈æuriraj formu s uƒçitanim podacima
      document.getElementById('measurer-select').value = state.currentMeasurer;
      document.getElementById('device-select').value = state.currentDevice;
      renderDeviceDropdown();
      document.getElementById('measurement-date').value = state.currentMeasurement.date;
      document.getElementById('air-temp').value = state.currentMeasurement.airTemp;
      document.getElementById('air-pressure').value = state.currentMeasurement.airPressure;
      document.getElementById('wind-direction').value = state.currentMeasurement.windDirection;
      document.getElementById('wind-speed').value = state.currentMeasurement.windSpeed;
      if (state.currentMeasurement.startTime) {
        const [hour, minute] = state.currentMeasurement.startTime.split(':');
        document.getElementById('start-hour').value = hour;
        document.getElementById('start-minute').value = minute;
      }
    } else {
      localStorage.removeItem('tempMeasurement');
    }
  }

  document.getElementById('password-form').addEventListener('submit', e => {
    e.preventDefault();
    const p = document.getElementById('password-input').value;
    const c = atob('MzczNw=='); // Obfuskirana lozinka
    if (p !== c) {
      alert("Neispravan pristupni kod!");
      return;
    }
    showScreen('login-screen');
  });
  
  document.getElementById('login-form').addEventListener('submit', e => {
    e.preventDefault();
    state.currentMeasurer = document.getElementById('measurer-select').value;
    state.currentDevice = document.getElementById('device-select').value;
    if (!state.currentMeasurer || !state.currentDevice) {
      alert("Odaberite mjeritelja i ureƒëaj za mjerenje!");
      return;
    }
    showScreen('template-landfill-screen');
    initLandfillGrid();
  });
  document.getElementById('go-to-history').addEventListener('click', () => {
    populateFilterDropdowns();
    updateHistoryList();
    showScreen('measurement-history');
  });
  document.getElementById('template-landfill-next').addEventListener('click', () => {
    const warn = document.getElementById('template-landfill-warning');
    if (!state.selectedLandfill) {
      warn.textContent = "Niste odabrali odlagali≈°te!";
      warn.style.display = "block";
      return;
    }
    warn.style.display = "none";
    state.editingIndex = -1;
    state.editingVentIndex = -1;
    document.getElementById('measurement-submit-btn').textContent = 'Spremi promjene';
    // Poni≈°ti podatke ako se zapoƒçinje novo mjerenje
    state.currentMeasurement = {
      measurer: state.currentMeasurer,
      device: state.currentDevice,
      landfill: state.selectedLandfill,
      date: new Date().toISOString().split('T')[0],
      airTemp: '',
      airPressure: '',
      windDirection: '',
      windSpeed: '',
      
      startTime: '',
      vents: []
    };
    clearMeasurementForm();
    showScreen('new-measurement');
    
    // Automatski popuni vremenske podatke
    autoFillWeatherData();
  });
  document.getElementById('measurement-form').addEventListener('submit', e => {
    e.preventDefault();
    const hour = document.getElementById('start-hour').value;
    const minute = document.getElementById('start-minute').value;
    if (!hour || !minute) {
      alert("Odaberite vrijeme poƒçetka (sat i minuta)!");
      return;
    }
    state.currentMeasurement.date = document.getElementById('measurement-date').value;
    state.currentMeasurement.airTemp = document.getElementById('air-temp').value;
    state.currentMeasurement.airPressure = document.getElementById('air-pressure').value;
    state.currentMeasurement.windDirection = document.getElementById('wind-direction').value;
    state.currentMeasurement.windSpeed = document.getElementById('wind-speed').value;
    
    state.currentMeasurement.startTime = `${hour}:${minute}`;
    document.getElementById('landfill-name-display').textContent = state.currentMeasurement.landfill.name;
    document.getElementById('landfill-map').src = state.currentMeasurement.landfill.image;
    
    // Dodano: spremi podatke u privremenu pohranu nakon unosa u formu
    localStorage.setItem('tempMeasurement', JSON.stringify(state.currentMeasurement));
    
    updateVentTable();
    updateMissingVentsWarning();
    showScreen('vent-mapping');
  });
  document.getElementById('add-vent-btn').addEventListener('click', showVentForm);
  document.getElementById('refresh-weather-btn').addEventListener('click', autoFillWeatherData);
  document.getElementById('vent-list').addEventListener('click', e => {
    const row = e.target.closest('tr');
    if (!row) return;
    const index = Array.from(row.parentNode.children).indexOf(row);
    editVent(index);
  });
  // Dodaj event listener za promjenu statusa
  document.querySelectorAll('input[name="vent-status"]').forEach(radio => {
    radio.addEventListener('change', toggleVentFields);
  });
  
  document.getElementById('vent-form').addEventListener('submit', e => {
    e.preventDefault();
    saveVentData();
  });
  document.getElementById('finish-measurement').addEventListener('click', finishMeasurement);
  document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);
  document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);
  updateHistoryList();
  if (localStorage.getItem('tempMeasurement') === null || !JSON.parse(localStorage.getItem('tempMeasurement')).landfill) {
      showScreen('password-screen');
  }
}

document.addEve
